<div class="dp-highlighter"><div class="bar"><div class="tools"><a href="#" onclick="dp.sh.Toolbar.Command('ViewSource',this);return false;">view plain</a><a href="#" onclick="dp.sh.Toolbar.Command('CopyToClipboard',this);return false;">copy to clipboard</a><a href="#" onclick="dp.sh.Toolbar.Command('PrintSource',this);return false;">print</a><a href="#" onclick="dp.sh.Toolbar.Command('About',this);return false;">?</a></div></div><ol class="dp-c" start="251"><li class="alt"><span><span class="keyword">public</span><span>&nbsp;</span><span class="keyword">function</span><span>&nbsp;write_record()&nbsp;{&nbsp;&nbsp;</span></span></li><li class=""><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span><span>(request::is_ajax())&nbsp;</span><span class="vars">$this</span><span>-&gt;template&nbsp;=&nbsp;</span><span class="keyword">new</span><span>&nbsp;View(</span><span class="string">'ajax'</span><span>);&nbsp;&nbsp;</span></span></li><li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><span>&nbsp;</span><span class="keyword">die</span><span>(</span><span class="string">'Invalid&nbsp;request.'</span><span>);&nbsp;&nbsp;</span></span></li><li class=""><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></li><li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;in_array(<span class="vars">$_POST</span><span>[</span><span class="string">'type'</span><span>],&nbsp;</span><span class="keyword">array</span><span>(</span><span class="string">'Sermons'</span><span>,</span><span class="string">'Aces'</span><span>,</span><span class="string">'Portraits'</span><span>,</span><span class="string">'Dedications'</span><span>))&nbsp;</span><span class="keyword">or</span><span>&nbsp;</span><span class="keyword">die</span><span>(</span><span class="string">'Invalid&nbsp;form&nbsp;request.'</span><span>);&nbsp;&nbsp;</span></span></li><li class=""><span>&nbsp;&nbsp;</span></li><li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;Field&nbsp;Types</span><span>&nbsp;&nbsp;</span></span></li><li class=""><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;&nbsp;&nbsp;Sermon:&nbsp;series,&nbsp;title,&nbsp;preacher,&nbsp;scripture,&nbsp;reader,&nbsp;date,&nbsp;disk,&nbsp;type</span><span>&nbsp;&nbsp;</span></span></li><li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;&nbsp;&nbsp;Aces:&nbsp;series,&nbsp;title,&nbsp;teacher,&nbsp;comment,&nbsp;date,&nbsp;disk</span><span>&nbsp;&nbsp;</span></span></li><li class=""><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;&nbsp;&nbsp;Portraits:&nbsp;date,&nbsp;speaker,&nbsp;comment,&nbsp;notice_sent</span><span>&nbsp;&nbsp;</span></span></li><li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;&nbsp;&nbsp;Dedications:&nbsp;official,&nbsp;child,&nbsp;comment,&nbsp;notice_sent</span><span>&nbsp;&nbsp;</span></span></li><li class=""><span>&nbsp;&nbsp;</span></li><li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="vars">$record</span><span>&nbsp;=&nbsp;Doctrine_Query::create()&nbsp;&nbsp;</span></span></li><li class=""><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&gt;from(<span class="vars">$_REQUEST</span><span>[</span><span class="string">'type'</span><span>])&nbsp;&nbsp;</span></span></li><li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&gt;where(<span class="string">'date&nbsp;=&nbsp;?'</span><span>,&nbsp;</span><span class="vars">$_REQUEST</span><span>[</span><span class="string">'date'</span><span>])&nbsp;&nbsp;</span></span></li><li class=""><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&gt;orderBy(<span class="string">'id&nbsp;desc'</span><span>)&nbsp;&nbsp;</span></span></li><li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&gt;execute()&nbsp;&nbsp;</span></li><li class=""><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&gt;getFirst();&nbsp;&nbsp;</span></li><li class="alt"><span>&nbsp;&nbsp;</span></li><li class=""><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span><span>(!</span><span class="vars">$record</span><span>)&nbsp;{&nbsp;&nbsp;</span></span></li><li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="vars">$record</span><span>&nbsp;=&nbsp;</span><span class="keyword">new</span><span>&nbsp;</span><span class="vars">$_REQUEST</span><span>[</span><span class="string">'type'</span><span>];&nbsp;&nbsp;</span></span></li><li class=""><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li class="alt"><span>&nbsp;&nbsp;</span></li><li class=""><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="vars">$record</span><span>-&gt;merge(</span><span class="vars">$_REQUEST</span><span>);&nbsp;&nbsp;</span></span></li><li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span><span>(in_array(</span><span class="vars">$_REQUEST</span><span>[</span><span class="string">'type'</span><span>],&nbsp;</span><span class="keyword">array</span><span>(</span><span class="string">'Sermons'</span><span>,</span><span class="string">'Aces'</span><span>)))&nbsp;{&nbsp;&nbsp;</span></span></li><li class=""><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="vars">$record</span><span>-&gt;disk&nbsp;=&nbsp;9;&nbsp;&nbsp;</span></span></li><li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li class=""><span>&nbsp;&nbsp;</span></li><li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span><span>(</span><span class="vars">$_REQUEST</span><span>[</span><span class="string">'type'</span><span>]&nbsp;==&nbsp;</span><span class="string">'Sermons'</span><span>)&nbsp;{&nbsp;&nbsp;</span></span></li><li class=""><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="vars">$record</span><span>-&gt;track&nbsp;=&nbsp;</span><span class="func">date</span><span>(</span><span class="string">'W'</span><span>,</span><span class="func">strtotime</span><span>(</span><span class="vars">$_REQUEST</span><span>[</span><span class="string">'date'</span><span>]));&nbsp;&nbsp;</span></span></li><li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="vars">$record</span><span>-&gt;year&nbsp;=&nbsp;</span><span class="func">date</span><span>(</span><span class="string">'Y'</span><span>,</span><span class="func">strtotime</span><span>(</span><span class="vars">$_REQUEST</span><span>[</span><span class="string">'date'</span><span>]));&nbsp;&nbsp;</span></span></li><li class=""><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li class="alt"><span>&nbsp;&nbsp;</span></li><li class=""><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span><span>(</span><span class="vars">$record</span><span>-&gt;trySave())&nbsp;&nbsp;</span></span></li><li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="vars">$this</span><span>-&gt;template-&gt;content&nbsp;=&nbsp;</span><span class="string">"Write&nbsp;successful!"</span><span>;&nbsp;&nbsp;</span></span></li><li class=""><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><span>&nbsp;&nbsp;</span></span></li><li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="vars">$this</span><span>-&gt;template-&gt;content&nbsp;=&nbsp;</span><span class="string">"Write&nbsp;failed!"</span><span>;&nbsp;&nbsp;</span></span></li><li class=""><span>}&nbsp;&nbsp;</span></li></ol><textarea style="display: none;" class="originalCode">	public function write_record() {
		if(request::is_ajax()) $this-&gt;template = new View('ajax');
		else die('Invalid request.');
		
		in_array($_POST['type'], array('Sermons','Aces','Portraits','Dedications')) or die('Invalid form request.');

		// Field Types
		//   Sermon: series, title, preacher, scripture, reader, date, disk, type
		//   Aces: series, title, teacher, comment, date, disk
		//   Portraits: date, speaker, comment, notice_sent
		//   Dedications: official, child, comment, notice_sent

		$record = Doctrine_Query::create()
			-&gt;from($_REQUEST['type'])
			-&gt;where('date = ?', $_REQUEST['date'])
			-&gt;orderBy('id desc')
			-&gt;execute()
			-&gt;getFirst();

		if(!$record) {
			$record = new $_REQUEST['type'];
		}

		$record-&gt;merge($_REQUEST);
		if(in_array($_REQUEST['type'], array('Sermons','Aces'))) {
			$record-&gt;disk = 9;
		}

		if($_REQUEST['type'] == 'Sermons') {
			$record-&gt;track = date('W',strtotime($_REQUEST['date']));
			$record-&gt;year = date('Y',strtotime($_REQUEST['date']));
		}

		if($record-&gt;trySave())
			$this-&gt;template-&gt;content = "Write successful!";
		else
			$this-&gt;template-&gt;content = "Write failed!";
	}</textarea></div>
